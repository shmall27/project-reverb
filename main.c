#include <libavcodec/avcodec.h>

const int packetSize = 600 + AV_INPUT_BUFFER_PADDING_SIZE;

int main() {

    // This is a test packet from OBS
    // If you run the Rust code and point your OBS to the port, this should be the output
    int testBuffer[600] = {0, 0, 0, 1, 2, 1, 208, 32, 140, 65, 33, 114, 76, 195, 42, 170, 25, 153, 17, 17, 17, 17, 17, 64, 242, 121, 128, 0, 0, 3, 0, 0, 15, 240, 88, 0, 0, 3, 0, 0, 3, 0, 118, 192, 0, 0, 3, 0, 0, 3, 0, 65, 192, 0, 0, 3, 0, 0, 11, 200, 0, 0, 3, 0, 1, 73, 0, 0, 3, 0, 18, 176, 0, 0, 3, 0, 146, 128, 0, 0, 3, 3, 166, 0, 0, 17, 112, 0, 0, 57, 32, 0, 0, 174, 128, 0, 1, 151, 0, 3, 114, 0, 6, 148, 0, 10, 104, 0, 16, 144, 0, 23, 112, 0, 29, 80, 0, 37, 32, 0, 44, 160, 0, 54, 96, 0, 63, 160, 0, 6, 84, 47, 123, 154, 198, 45, 107, 90, 214, 165, 41, 80, 232, 134, 62, 255, 254, 196, 67, 132, 118, 92, 0, 207, 14, 160, 230, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 5, 108, 145, 133, 75, 188, 252, 64, 184, 98, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 140, 128, 2, 232, 111, 130, 249, 96, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 81, 64, 4, 81, 206, 224, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 2, 206, 7, 30, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 9, 168, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 11, 24, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 4, 188, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 198, 128, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 19, 208, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 1, 29, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 8, 136, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 68, 64, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 1, 85, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 4, 204, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 15, 120, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 41, 224, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 87, 192, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 170, 128, 0, 0, 3, 0, 0, 3, 0, 0, 3, 1, 29, 0, 0, 3, 0, 0, 3, 0, 0, 3, 1, 213, 0, 0, 3, 0, 0, 3, 0, 0, 3, 2, 202, 0, 0, 3, 0, 0, 3, 0, 0, 3, 3, 214, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 3, 0, 0, 10, 248, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

    AVCodec *videoCodec = avcodec_find_decoder(AV_CODEC_ID_HEVC);

    AVCodecContext *codecContext = avcodec_alloc_context3(videoCodec);
    avcodec_open2(codecContext, videoCodec, NULL);

    AVFrame *frame = av_frame_alloc();
    
    uint8_t *buf = av_malloc(packetSize);
    int i;
    for (i=0; i<600; i++) {
        buf[i] = testBuffer[i];
    }

    AVPacket *packet = av_packet_alloc();
    int testPacket = av_packet_from_data(packet, buf, packetSize);

    int sendPacketResponse = avcodec_send_packet(codecContext, testPacket);

    // This is what returns an EOF error currently
    int recFrameResponse = avcodec_receive_frame(codecContext, frame);

    printf("%s\n", av_err2str(recFrameResponse));
    return 0;
}